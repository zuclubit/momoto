name: Rust CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'crates/**'
      - 'tests/**'
      - 'benches/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/rust-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'crates/**'
      - 'tests/**'
      - 'benches/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/rust-ci.yml'

concurrency:
  group: rust-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # TIER 0: Quality Gates (Governance Enforcement)
  # ============================================

  # Gate 1: Code Quality
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy (strict)
        run: cargo clippy --workspace --all-features -- -D warnings -D clippy::all

      - name: Run Clippy (pedantic on core crates)
        run: |
          cargo clippy -p momoto-core -- -D warnings -W clippy::pedantic
          cargo clippy -p momoto-metrics -- -D warnings -W clippy::pedantic

  # Gate 2: Tests (All Platforms)
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --workspace

      - name: Run tests (all features)
        run: cargo test --workspace --all-features

  # Gate 3: MSRV Check
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust 1.70 (MSRV)
        uses: dtolnay/rust-action@1.70.0

      - name: Check compilation on MSRV
        run: cargo check --workspace

  # Gate 4: Documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@nightly
        with:
          components: rust-docs

      - name: Check documentation
        env:
          RUSTDOCFLAGS: -D warnings
        run: cargo doc --workspace --no-deps --all-features

      - name: Test documentation examples
        run: cargo test --workspace --doc

  # Gate 5: WASM Build
  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: |
          cd crates/momoto-wasm
          wasm-pack build --target web --release

      - name: Check WASM size
        run: |
          WASM_SIZE=$(stat -c%s crates/momoto-wasm/pkg/momoto_wasm_bg.wasm 2>/dev/null || stat -f%z crates/momoto-wasm/pkg/momoto_wasm_bg.wasm)
          echo "WASM size: $WASM_SIZE bytes"
          # Fail if over 1MB (should be ~400KB)
          if [ $WASM_SIZE -gt 1048576 ]; then
            echo "ERROR: WASM bundle exceeds 1MB size limit"
            exit 1
          fi

      - name: Verify TypeScript definitions
        run: |
          if [ ! -f crates/momoto-wasm/pkg/momoto_wasm.d.ts ]; then
            echo "ERROR: TypeScript definitions not generated"
            exit 1
          fi

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: crates/momoto-wasm/pkg/

  # Gate 6: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  # Gate 7: Dependency Check
  dependencies:
    name: Dependency Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Check for unused dependencies
        run: |
          cargo install cargo-machete
          cargo machete || true  # Report but don't fail yet

      - name: Verify zero dependencies (core crates)
        run: |
          echo "Checking momoto-core has no runtime dependencies..."
          DEPS=$(cargo tree -p momoto-core --no-dev-deps --depth 1 2>/dev/null | wc -l)
          if [ $DEPS -gt 1 ]; then
            echo "ERROR: momoto-core should have zero runtime dependencies"
            cargo tree -p momoto-core --no-dev-deps
            exit 1
          fi

          echo "Checking momoto-metrics has no runtime dependencies..."
          DEPS=$(cargo tree -p momoto-metrics --no-dev-deps --depth 1 2>/dev/null | wc -l)
          # Allow momoto-core as dependency
          if [ $DEPS -gt 2 ]; then
            echo "ERROR: momoto-metrics should only depend on momoto-core"
            cargo tree -p momoto-metrics --no-dev-deps
            exit 1
          fi

      - name: Check dependency direction
        run: |
          echo "Verifying no circular dependencies..."
          # momoto-core should not depend on higher crates
          if cargo tree -p momoto-core --no-dev-deps | grep -E "momoto-(metrics|intelligence|materials|wasm)"; then
            echo "ERROR: momoto-core has forbidden upward dependencies"
            exit 1
          fi

          # momoto-metrics should not depend on higher crates
          if cargo tree -p momoto-metrics --no-dev-deps | grep -E "momoto-(intelligence|materials|wasm)"; then
            echo "ERROR: momoto-metrics has forbidden upward dependencies"
            exit 1
          fi

  # ============================================
  # TIER 1: Stability Verification
  # ============================================

  # API Diff Check (requires baseline)
  api-stability:
    name: API Stability Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install cargo-public-api
        run: cargo install cargo-public-api

      - name: Check API changes (momoto-core)
        run: |
          echo "Checking for API changes in momoto-core (FROZEN module)..."
          cargo public-api -p momoto-core > /tmp/current-api.txt

          # Get base branch API
          git checkout ${{ github.base_ref }} -- crates/momoto-core
          cargo public-api -p momoto-core > /tmp/base-api.txt
          git checkout ${{ github.sha }} -- crates/momoto-core

          # Compare
          if ! diff -q /tmp/base-api.txt /tmp/current-api.txt > /dev/null 2>&1; then
            echo "⚠️  API changes detected in FROZEN module momoto-core:"
            diff /tmp/base-api.txt /tmp/current-api.txt || true
            echo ""
            echo "FROZEN modules require RFC approval for any API change."
            echo "See STABILITY.md for details."
            # Note: Not failing here, but flagging for review
          else
            echo "✓ No API changes in momoto-core"
          fi

      - name: Check API changes (momoto-metrics)
        run: |
          echo "Checking for API changes in momoto-metrics (FROZEN module)..."
          cargo public-api -p momoto-metrics > /tmp/current-api.txt

          git checkout ${{ github.base_ref }} -- crates/momoto-metrics
          cargo public-api -p momoto-metrics > /tmp/base-api.txt
          git checkout ${{ github.sha }} -- crates/momoto-metrics

          if ! diff -q /tmp/base-api.txt /tmp/current-api.txt > /dev/null 2>&1; then
            echo "⚠️  API changes detected in FROZEN module momoto-metrics:"
            diff /tmp/base-api.txt /tmp/current-api.txt || true
            echo ""
            echo "FROZEN modules require RFC approval for any API change."
          else
            echo "✓ No API changes in momoto-metrics"
          fi

  # RFC Reference Check
  rfc-check:
    name: RFC Reference Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Check for RFC reference in significant changes
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if core/metrics modules were changed
          if echo "$CHANGED_FILES" | grep -E "crates/momoto-(core|metrics)/src/"; then
            echo "Changes detected in FROZEN modules (momoto-core, momoto-metrics)"

            # Check if PR description references an RFC
            PR_BODY="${{ github.event.pull_request.body }}"
            if ! echo "$PR_BODY" | grep -iE "(RFC-[0-9]+|implements.*rfc|bug.?fix|fix:|typo|doc)" > /dev/null; then
              echo "⚠️  Changes to FROZEN modules should reference an RFC or be marked as bug fix"
              echo "Add 'Implements: RFC-XXXX' or 'fix:' prefix to PR description"
            fi
          fi

          # Check if new public APIs are added without RFC
          if git diff origin/${{ github.base_ref }}...HEAD -- '*.rs' | grep -E "^\+.*pub (fn|struct|enum|trait|type|const)" | head -5; then
            echo ""
            echo "New public APIs detected. If adding to CONSERVED modules, RFC may be required."
            echo "See rfcs/RFC-PROCESS.md for guidance."
          fi

  # ============================================
  # TIER 2: Performance Validation
  # ============================================

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: cargo bench --workspace -- --noplot

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: target/criterion/

  # ============================================
  # Final Status Gate
  # ============================================

  all-checks:
    name: All Rust Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, msrv, docs, wasm, security, dependencies]
    if: always()
    steps:
      - name: Verify all checks passed
        run: |
          echo "Checking job results..."

          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint check failed"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi

          if [ "${{ needs.msrv.result }}" != "success" ]; then
            echo "❌ MSRV check failed"
            exit 1
          fi

          if [ "${{ needs.docs.result }}" != "success" ]; then
            echo "❌ Documentation check failed"
            exit 1
          fi

          if [ "${{ needs.wasm.result }}" != "success" ]; then
            echo "❌ WASM build failed"
            exit 1
          fi

          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "❌ Security audit failed"
            exit 1
          fi

          if [ "${{ needs.dependencies.result }}" != "success" ]; then
            echo "❌ Dependency validation failed"
            exit 1
          fi

          echo "✅ All Rust CI checks passed"

  # ============================================
  # Release Gate (for tags only)
  # ============================================

  release-ready:
    name: Release Readiness
    runs-on: ubuntu-latest
    needs: [all-checks, benchmarks]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Verify version consistency
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          CARGO_VERSION=$(grep -m1 'version = ' Cargo.toml | cut -d'"' -f2)

          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "ERROR: Tag version ($TAG_VERSION) doesn't match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

          echo "✓ Version $TAG_VERSION is consistent"

      - name: Check changelog entry
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if ! grep -q "## \[$TAG_VERSION\]" CHANGELOG.md; then
            echo "ERROR: No changelog entry for version $TAG_VERSION"
            exit 1
          fi
          echo "✓ Changelog entry exists"

      - name: Verify stability documentation
        run: |
          for doc in API_STABILITY.md STABILITY.md SECURITY.md CONTRIBUTING.md; do
            if [ ! -f "$doc" ]; then
              echo "ERROR: Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "✓ All stability documentation present"
